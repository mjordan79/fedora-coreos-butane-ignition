######################################################################################################################################################
# Butane config file by Renato Perini                                                                                                                #
# Generate the Ignition file with:                                                                                                                   #
# docker run --rm -v .\butane_ignition_pxe_flatcar.bu:/config.bu:z quay.io/coreos/butane:release --pretty --strict /config.bu > ignition_flatcar.ign #
######################################################################################################################################################
variant: flatcar
version: 1.1.0

passwd:
  users:
    - name: mjordan
      password_hash: $y$j9T$8leCHKjDXk5Ne2.SraPgN.$HbST8G0cp1a9EVQIAgWodJ07zG/4IpUPtAMpJcdO118
      ssh_authorized_keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDoeY8qlfz9kW84ZwkMwQqFTfhDDc5zkBWuFZ7Q9m9TAac01ImqhNIF05Q4vxQcfp9z9fBjtqTQjTe8joXfE5o+LTT8jPkNcMF9857oH0IAlWx1wDq9cuAiXsrFW7zRw59FTURAXw6CDih0ykfB4K4zFuLq2PHqT9i0Ra+PKPKL0jjzaZMHyQmobXjML5s/2b2tfEs+4HOdxe3YNzdl0ExmdyIedTvDo/t1ObKwFw8bVd8g+9MOgeAA3RRIG6yrvb7Q9eLOCUtbQC+iei7n3CFdY6P9n0H/zckIyEmX21igZJeqj4khjN7+OfQJ1+xVG+HB7chYw4J/y34s4y9lo9UO2cGWmFxvmUlO1wjJmLAfwJCoDOJe2WUwnBNBS8/YvACCHexiMQm7/ENeCgY7NchAMFlnxs8Dq7bh2qavDdftXvyR4xCfO1XVD+sTi8DKMp4qiYc/iU+iRLM1KHwXJuOreVlAP6kxLkvyX2n2ahT+DWUrOviBfHE9dGqQ/etVhX1jSwjcBzAOaNNNvpnBa7lZack3jZocnk2Z4gFTHYwJnD9SQjiXbhdoSjuL7JB7KV1+R1hnwBFtzrK/vV+KnlHDN+AJzXtg98EVei/ozVK+vuG4H6+GE9WNbDZhXeRpwPPrRQLkF9HdC6dGXZa/dxhpgOcQ6jxeh1HggglS1FcI6w==
      home_dir: /home/mjordan
      no_create_home: false
      groups:
        - wheel
        - sudo
        - docker
      shell: /bin/bash

systemd:
  units:
    - name: installer.service
      enabled: true
      contents: |
        [Unit]
        Requires=network-online.target
        After=network-online.target
        ConditionPathExists=!/var/lib/%N.stamp
        [Service]
        Type=oneshot
        TimeoutStartSec=600
        RemainAfterExit=yes
        ExecStart=/opt/install.sh
        ExecStart=/bin/touch /var/lib/%N.stamp
        ExecStart=/bin/systemctl disable installer.service
        ExecStart=/bin/systemctl --no-block reboot
        [Install]
        WantedBy=multi-user.target

storage:
  files:
    - path: /opt/ignition.json
      mode: 0644
      contents:
        source: http://192.169.0.10/ignition/ignition_flatcar.ign
    - path: /opt/install.sh
      mode: 0777
      contents:
        inline: |
          #!/bin/bash 
          rht=$(lsblk | wc --lines) 
          if [ $rht -eq 3 ]
          then
            echo Installing Flatcar Linux on disk... 
            flatcar-install -d /dev/sda -i /opt/ignition.json
          else
            echo Disabling installer.service, no longer needed.
            systemctl disable installer.service
          fi 
    - path: /etc/vconsole.conf
      mode: 0644
      contents:
        inline: KEYMAP=it
    - path: /etc/ssh/sshd_config.d/10-custom.conf
      contents:
        inline: |
          X11Forwarding no
          GSSAPIAuthentication no
    - path: /etc/systemd/network/00-eth0.network
      contents:
        inline: |
          [Match]
          Name=eth0

          [Network]
          DNS=8.8.8.8
          Address=192.169.0.20/24
          Gateway=192.169.0.1
    - path: /etc/hosts
      overwrite: false
      append:
        - inline: |
            192.169.0.20 flatmaster1.digitalnucleus.it
            192.169.0.21 flatmaster2.digitalnucleus.it
            192.169.0.22 flatmaster3.digitalnucleus.it
            192.169.0.23 flatworker1.digitalnucleus.it
            192.169.0.24 flatworker2.digitalnucleus.it
    - path: /etc/hostname
      mode: 0644
      contents:
        inline: flatmaster1.digitalnucleus.it

  links:
    - path: /etc/localtime
      target: ../usr/share/zoneinfo/Europe/Rome

    
